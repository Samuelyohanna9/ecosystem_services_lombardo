<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Urban Green â€¢ Lombardy</title>

  <link href="./vendor/maplibre-gl.css" rel="stylesheet" />
  <style>
    :root { --bg:#0b1220; --panel:#0d1426; --muted:#8fa0bf; --text:#e6edf7; --brand:#22c55e; }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    #app{display:grid;grid-template-columns:360px 1fr;grid-template-rows:100vh}
    #sidebar{background:var(--panel);border-right:1px solid #1f2937;padding:14px 14px 18px;overflow:auto}
    #map{position:relative} #mapCanvas{position:absolute;inset:0}
    h1{font-size:18px;margin:0 0 4px} .muted{color:var(--muted)}
    .controls{display:flex;gap:8px;align-items:center;margin:10px 0 12px}
    .pill{padding:6px 10px;border:1px solid #203152;border-radius:999px;background:#091122}
    .search{width:100%;padding:8px 10px;border:1px solid #203152;border-radius:10px;background:#091122;color:var(--text)}
    .kbd{font:12px/1.2 ui-monospace,Menlo,Consolas;color:var(--muted);margin-top:6px}
    .card{background:#0b1220;border:1px solid #1e2b4a;border-radius:12px;padding:12px;margin:12px 0}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .kpi{background:#091122;border:1px solid #203152;border-radius:10px;padding:10px}
    .kpi .v{font-size:16px;font-weight:600}
    .footer{position:absolute;left:10px;bottom:8px;background:#0b1220cc;border:1px solid #1e2b4a;border-radius:8px;padding:6px 8px;font-size:12px}
    .legend{display:flex;gap:10px;align-items:center;margin-top:6px}
    .sw{width:14px;height:14px;border-radius:50%;background:#22c55e;border:1px solid #052e16}
    .maplibregl-ctrl-attrib{font-size:12px}
    .maplibregl-popup-content{background:#0b1220;color:var(--text);border:1px solid #1e2b4a;border-radius:12px}
    .maplibregl-popup-tip{border-top-color:#1e2b4a}
    .popup h3{margin:0 0 6px;font-size:15px;display:flex;gap:8px;align-items:center}
    .popup .kv{color:var(--muted);margin:2px 0}
    @media (max-width:900px){#app{grid-template-columns:1fr;grid-template-rows:280px 1fr}#sidebar{grid-row:1}#map{grid-row:2}}
  </style>
</head>
<body>
  <div id="app">
    <aside id="sidebar">
      <h1>Lombardy Green Areas</h1>
      <div class="muted">OSM basemap â€¢ PMTiles on Cloudflare â€¢ Click polygons for details.</div>

      <div class="controls">
        <button id="btnReset" class="pill" title="Reset view">Reset</button>
      </div>

      <input id="txtSearch" class="search" type="text"
             placeholder="Filter: econ>1000 co2>50 pm>10 h2o>1000 energy>5 o2>1 stock>100 pmval>5" />
      <div class="kbd">Use space to combine rules (e.g. <code>econ&gt;500 co2&gt;20</code>).</div>

      <div class="card">
        <div class="grid">
          <div class="kpi"><div class="t muted">COâ‚‚ sequestered (yr)</div><div id="kpiCo2" class="v">â€”</div></div>
          <div class="kpi"><div class="t muted">PM captured (yr)</div><div id="kpiPm" class="v">â€”</div></div>
          <div class="kpi"><div class="t muted">Water retained (yr)</div><div id="kpiH2o" class="v">â€”</div></div>
          <div class="kpi"><div class="t muted">Cooling (kWh/yr)</div><div id="kpiEnergy" class="v">â€”</div></div>
          <div class="kpi" style="grid-column:1/-1"><div class="t muted">Economic value (â‚¬)</div><div id="kpiEcon" class="v">â€”</div></div>
        </div>
      </div>

      <div class="legend"><span class="sw"></span><span class="muted">Green areas</span></div>
    </aside>

    <main id="map">
      <div id="mapCanvas"></div>
      <div class="footer">Â© You â€¢ OpenStreetMap â€¢ MapLibre â€¢ PMTiles</div>
    </main>
  </div>

  <script src="./vendor/maplibre-gl.js"></script>
  <script src="./vendor/pmtiles.js"></script>
  <script src="./vendor/basemaps.js"></script>
  <script>
    const PMTILES_URL = "https://pub-df9eaf452da44f0ea2cbbcb1a6cd55ac.r2.dev/trees.pmtiles";
    const SOURCE_LAYER = "trees";

    const protocol = new pmtiles.Protocol();
    maplibregl.addProtocol("pmtiles", protocol.tile);

    const style = {
      version: 8,
      glyphs: "https://demotiles.maplibre.org/font/{fontstack}/{range}.pbf",
      sources: {
        osm: {
          type: "raster",
          tiles: ["https://tile.openstreetmap.org/{z}/{x}/{y}.png"],
          tileSize: 256,
          attribution: "Â© OpenStreetMap contributors"
        }
      },
      layers: [{ id: "osm", type: "raster", source: "osm" }]
    };

    const map = new maplibregl.Map({
      container: "mapCanvas",
      style,
      center: [9.154940775917993, 45.46043264982563],
      zoom: 10.5
    });
    map.addControl(new maplibregl.NavigationControl(), "top-right");

    map.on("load", async () => {
      const archive = new pmtiles.PMTiles(PMTILES_URL);
      protocol.add(archive);
      map.addSource("areas", { type: "vector", url: `pmtiles://${PMTILES_URL}` });

      map.addLayer({
        id: "areas-fill",
        type: "fill",
        source: "areas",
        "source-layer": SOURCE_LAYER,
        paint: { "fill-color": "#22c55e", "fill-opacity": 0.45 }
      });

      map.addLayer({
        id: "areas-outline",
        type: "line",
        source: "areas",
        "source-layer": SOURCE_LAYER,
        paint: { "line-color": "#052e16", "line-width": 1.2 }
      });

      map.on("mouseenter", "areas-fill", () => map.getCanvas().style.cursor = "pointer");
      map.on("mouseleave", "areas-fill", () => map.getCanvas().style.cursor = "");

      map.on("click", "areas-fill", (e) => {
        const p = (e.features[0] && e.features[0].properties) || {};
        const co2 = nz(p.co2_sequestered_kg, p.co2_absorption_kg);
        const pm  = nz(p.pm10_capture_g, p.pm25_capture_g);
        const h2o = nz(p.h2o_retention_l, p.h2o_precipitation_l);
        const energy = p.cooling_savings_kwh;
        const econ = nz(p.economic_value_eur, p.energy_value_eur, p.co2_absorption_value_eur);

        new maplibregl.Popup({ offset: 12 })
          .setLngLat(e.lngLat)
          .setHTML(
            `<div class="popup">
               <h3>ðŸŒ² Green area</h3>
               <div class="kv">COâ‚‚ (year): <strong>${fmt(co2)}</strong> kg</div>
               <div class="kv">PM (year): <strong>${fmt(pm)}</strong> g</div>
               <div class="kv">Water (year): <strong>${fmt(h2o)}</strong> L</div>
               <div class="kv">Cooling: <strong>${fmt(energy)}</strong> kWh</div>
               <div class="kv">Economic value: <strong>â‚¬ ${fmt(econ)}</strong></div>
             </div>`
          )
          .addTo(map);

        setKPI("kpiCo2", co2, "kg");
        setKPI("kpiPm", pm, "g");
        setKPI("kpiH2o", h2o, "L");
        setKPI("kpiEnergy", energy, "kWh");
        setKPI("kpiEcon", econ, "â‚¬");
      });

      const txt = document.getElementById("txtSearch");
      function fieldExpr(key){
        switch(key){
          case "econ": return ["coalesce",["get","economic_value_eur"],["get","energy_value_eur"],["get","co2_absorption_value_eur"]];
          case "co2":  return ["coalesce",["get","co2_sequestered_kg"],["get","co2_absorption_kg"]];
          case "pm":   return ["coalesce",["get","pm10_capture_g"],["get","pm25_capture_g"]];
          case "h2o":  return ["coalesce",["get","h2o_retention_l"],["get","h2o_precipitation_l"]];
          case "energy": return ["get","cooling_savings_kwh"];
          case "o2":   return ["get","o2_produced_kg"];
          case "stock": return ["get","co2_stock_kg"];
          case "pmval": return ["get","pm10_value_eur"];
          default: return null;
        }
      }
      function applyFilter(){
        const q = (txt.value||"").toLowerCase().trim();
        if(!q){ map.setFilter("areas-fill", null); return; }
        const filters = ["all"];
        for(const part of q.split(/\s+/).filter(Boolean)){
          const m = part.match(/(econ|co2|pm|h2o|energy|o2|stock|pmval)\s*(>=|<=|>|<|=)\s*(\d+(?:\.\d+)?)/);
          if(!m) continue;
          const [,key,op,num] = m, field = fieldExpr(key);
          if(!field) continue;
          const v = parseFloat(num);
          filters.push(op===">"? [">",field,v] : op==="<" ? ["<",field,v] : op===">=" ? [">=",field,v] : op==="<=" ? ["<=",field,v] : ["==",field,v]);
        }
        map.setFilter("areas-fill", filters.length>1 ? filters : null);
      }
      txt.addEventListener("input", applyFilter);

      document.getElementById("btnReset").addEventListener("click", () => {
        map.easeTo({center:[9.154940775917993,45.46043264982563], zoom:10.5});
        txt.value=""; applyFilter();
        setKPI("kpiCo2"); setKPI("kpiPm"); setKPI("kpiH2o"); setKPI("kpiEnergy"); setKPI("kpiEcon");
      });
    });

    function nz(){ for (let i=0;i<arguments.length;i++){ const n = Number(arguments[i]); if(isFinite(n)) return n; } return null; }
    function fmt(v){ if(v===undefined||v===null||v!==v) return "â€”"; const n=Number(v); return isFinite(n)? n.toLocaleString(undefined,{maximumFractionDigits:0}) : "â€”"; }
    function setKPI(id, v, unit){ const el=document.getElementById(id); el.textContent=(v===undefined||v===null||v!==v)?"â€”":`${Number(v).toLocaleString(undefined,{maximumFractionDigits:0})}${unit?` ${unit}`:""}`; }
    window.addEventListener("unload", ()=> protocol.removeAll());
  </script>
</body>
</html>

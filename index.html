<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Lombardy Green Areas • PMTiles + MapLibre</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link href="./vendor/maplibre-gl.css" rel="stylesheet" />
  <style>
    html, body, #map { height: 100%; margin: 0; padding: 0; }
    .maplibregl-ctrl-attrib { font-size: 12px; }
    .panel {
      position: absolute; top: 10px; left: 10px; z-index: 1000;
      background: #fff; padding: 6px 8px; border-radius: 6px;
      font: 14px system-ui, sans-serif; box-shadow: 0 2px 8px rgba(0,0,0,.12);
      display: flex; gap: 10px; align-items: center;
      pointer-events: auto;
    }
    button { cursor: pointer; }
    .popup { font: 13px/1.35 system-ui, sans-serif; }
    .popup h3 { margin: 0 0 4px; font-size: 15px; }
    .popup .kv { color: #555; }
  </style>
</head>
<body>
  <div id="map"></div>

  <div class="panel">
    <label><input id="orthoToggle" type="checkbox" /> Orthophoto</label>
    <button id="zoomToOrtho" type="button">Zoom to orthophoto</button>
  </div>

  <script src="./vendor/maplibre-gl.js"></script>
  <script src="./vendor/pmtiles.js"></script>
  <script src="./vendor/basemaps.js"></script>

  <script>
    // ---- CONFIG ----
    const PMTILES_URL = "https://pub-df9eaf452da44f0ea2cbbcb1a6cd55ac.r2.dev/trees.pmtiles";
    const SOURCE_LAYER = "trees";         // Tippecanoe -l trees
    const START_CENTER = [9.154940775918, 45.460432649826]; // Lombardy center from your data
    const START_ZOOM = 10.5;

    // Register PMTiles protocol so MapLibre understands pmtiles:// URLs
    const protocol = new pmtiles.Protocol();
    maplibregl.addProtocol("pmtiles", protocol.tile);

    // Base style with OSM raster
    const style = {
      "version": 8,
      "glyphs": "https://demotiles.maplibre.org/font/{fontstack}/{range}.pbf",
      "sources": {
        "osm": {
          "type": "raster",
          "tiles": ["https://tile.openstreetmap.org/{z}/{x}/{y}.png"],
          "tileSize": 256,
          "attribution": "© OpenStreetMap contributors"
        },
        "ortho": {
          "type": "raster",
          "tiles": [
            "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}"
          ],
          "tileSize": 256,
          "attribution": "Esri World Imagery"
        }
      },
      "layers": [
        { "id": "osm", "type": "raster", "source": "osm" },
        { "id": "ortho", "type": "raster", "source": "ortho", "layout": { "visibility": "none" } }
      ]
    };

    const map = new maplibregl.Map({
      container: "map",
      style,
      center: START_CENTER,
      zoom: START_ZOOM,
      hash: true
    });

    map.addControl(new maplibregl.NavigationControl(), "top-right");
    map.addControl(new maplibregl.ScaleControl({ maxWidth: 200, unit: "metric" }));
    map.addControl(new maplibregl.AttributionControl({ compact: true }));

    // Attach PMTiles archive (prefetch & metadata cache)
    const archive = new pmtiles.PMTiles(PMTILES_URL);
    protocol.add(archive);

    map.on("load", () => {
      // Add PMTiles vector source
      map.addSource("trees", {
        type: "vector",
        url: `pmtiles://${PMTILES_URL}`
      });

      // Fill polygons (green areas)
      map.addLayer({
        id: "trees-fill",
        type: "fill",
        source: "trees",
        "source-layer": SOURCE_LAYER,
        paint: {
          "fill-color": "#22c55e",
          "fill-opacity": 0.35
        }
      });

      // Outline
      map.addLayer({
        id: "trees-outline",
        type: "line",
        source: "trees",
        "source-layer": SOURCE_LAYER,
        paint: {
          "line-color": "#14532d",
          "line-width": 1.2
        }
      });

      // Click popup: uses known fields from your GeoJSON
      map.on("click", "trees-fill", (e) => {
        if (!e.features || !e.features.length) return;
        const f = e.features[0];
        const p = f.properties || {};

        const co2 = p.co2_sequestered_kg ?? p.co2_absorption_kg;
        const pm  = p.pm10_capture_g ?? p.pm25_capture_g;
        const h2o = p.h2o_retention_l ?? p.h2o_precipitation_l;
        const en  = p.cooling_savings_kwh;
        const val = p.economic_value_eur ?? p.energy_value_eur ?? p.co2_absorption_value_eur;

        const html = `
          <div class="popup">
            <h3>${(p.species_name || p.site_name || "Green area")}</h3>
            <div class="kv">CO₂ sequestered (yr): <strong>${co2 ?? "—"} kg</strong></div>
            <div class="kv">PM captured (yr): <strong>${pm ?? "—"} g</strong></div>
            <div class="kv">Water retained (yr): <strong>${h2o ?? "—"} L</strong></div>
            <div class="kv">Cooling savings (yr): <strong>${en ?? "—"} kWh</strong></div>
            <div class="kv">Economic value: <strong>${val ?? "—"} €</strong></div>
          </div>
        `;
        new maplibregl.Popup({ closeButton: true })
          .setLngLat(e.lngLat)
          .setHTML(html)
          .addTo(map);
      });

      map.on("mouseenter", "trees-fill", () => map.getCanvas().style.cursor = "pointer");
      map.on("mouseleave", "trees-fill", () => map.getCanvas().style.cursor = "");

      // Orthophoto toggle
      const orthoToggle = document.getElementById("orthoToggle");
      orthoToggle.addEventListener("change", () => {
        map.setLayoutProperty("ortho", "visibility", orthoToggle.checked ? "visible" : "none");
      });

      // "Zoom to orthophoto" -> just fly to Lombardy bounds/center
      document.getElementById("zoomToOrtho").addEventListener("click", () => {
        map.easeTo({ center: START_CENTER, zoom: 12, duration: 800 });
      });
    });

    // Clean up protocol on unload
    window.addEventListener("unload", () => protocol.removeAll());
  </script>
</body>
</html>

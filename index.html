<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Urban Green • Lombardy</title>

  <link href="./vendor/maplibre-gl.css" rel="stylesheet" />
  <style>
    :root{
      --bg:#0b1220; --panel:#0d1426; --muted:#97a6c6; --text:#e6edf7; --brand:#22c55e; --line:#173b2a;
    }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    #map{position:fixed;inset:0}
    .maplibregl-ctrl-attrib{font-size:12px}

    /* Sidebar */
    #sidebar{
      position:fixed; left:0; top:0; bottom:0; width:380px; max-width:94vw;
      background:var(--panel); border-right:1px solid #18253d; box-shadow: 6px 0 24px rgba(0,0,0,.25);
      transform:translateX(-102%); transition:transform .25s ease; z-index:10; overflow:auto;
      display:flex; flex-direction:column;
    }
    #sidebar.open{ transform:none; }
    .sb-header{display:flex; gap:10px; align-items:center; padding:14px 16px 10px; border-bottom:1px solid #18253d}
    .forest-badge{width:38px;height:38px;border-radius:12px;display:grid;place-items:center;background:#0b172b;border:1px solid #22365e}
    .forest-badge svg{width:22px;height:22px}
    .title-wrap{flex:1}
    .title{margin:0;font-size:18px}
    .subtitle{margin:0;color:var(--muted);font-size:13px}
    .btn-close{appearance:none;border:0;background:#0b172b;color:var(--muted);border:1px solid #22365e;border-radius:10px;padding:6px 10px;cursor:pointer}

    .section{padding:14px 16px}
    .kpis{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .kpi{background:#0b1220;border:1px solid #1b2b4b;border-radius:12px;padding:10px;display:flex;gap:10px}
    .kpi svg{width:22px;height:22px;flex:0 0 auto;opacity:.9}
    .kpi .t{color:var(--muted);font-size:12px}
    .kpi .v{font-weight:700;font-size:16px}
    .row{display:grid;grid-template-columns:120px 1fr;gap:8px;margin:6px 0}
    .muted{color:var(--muted)}
    .footer{position:fixed;left:10px;bottom:8px;background:#0b1220cc;border:1px solid #1e2b4a;border-radius:8px;padding:6px 8px;font-size:12px;color:var(--muted);z-index:5}

    @media (max-width:720px){
      .kpis{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <aside id="sidebar" aria-hidden="true">
    <div class="sb-header">
      <div class="forest-badge" aria-hidden="true">
        <!-- forest icon -->
        <svg viewBox="0 0 24 24" fill="none"><path d="M12 2l4 6H8l4-6Zm0 4l6 9H6l6-9Zm0 7l5 8H7l5-8Z" fill="#22c55e"/><path d="M12 2l4 6H8l4-6Zm0 4l6 9H6l6-9Zm0 7l5 8H7l5-8Z" stroke="#0f291e" stroke-opacity=".7"/></svg>
      </div>
      <div class="title-wrap">
        <h1 class="title" id="sb-title">Green area</h1>
        <p class="subtitle" id="sb-sub">Click a polygon to see details</p>
      </div>
      <button class="btn-close" id="sb-close" type="button">✕</button>
    </div>

    <div class="section">
      <div class="row"><div class="muted">Site</div><div id="sb-site">—</div></div>
    </div>

    <div class="section">
      <div class="kpis">
        <div class="kpi">
          <svg viewBox="0 0 24 24"><path d="M7 20a5 5 0 1 1 10 0H7Z" fill="#22c55e"/><circle cx="9" cy="10" r="1.5" fill="#22c55e"/><circle cx="15" cy="10" r="1.5" fill="#22c55e"/></svg>
          <div><div class="t">CO₂ sequestered (yr)</div><div class="v" id="k_co2">—</div></div>
        </div>
        <div class="kpi">
          <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="9" fill="#22c55e"/><path d="M12 6v12M6 12h12" stroke="#0f291e" stroke-width="2"/></svg>
          <div><div class="t">PM captured (yr)</div><div class="v" id="k_pm">—</div></div>
        </div>
        <div class="kpi">
          <svg viewBox="0 0 24 24"><path d="M5 10c3 0 3-6 7-6s4 6 7 6v7a3 3 0 0 1-3 3H8a3 3 0 0 1-3-3v-7Z" fill="#22c55e"/></svg>
          <div><div class="t">Water retained (yr)</div><div class="v" id="k_h2o">—</div></div>
        </div>
        <div class="kpi">
          <svg viewBox="0 0 24 24"><path d="M4 17h16M6 13h12M8 9h8M10 5h4" stroke="#22c55e" stroke-width="2"/></svg>
          <div><div class="t">Cooling (kWh/yr)</div><div class="v" id="k_energy">—</div></div>
        </div>
        <div class="kpi" style="grid-column:1/-1">
          <svg viewBox="0 0 24 24"><path d="M12 3l2.5 5 5.5.8-4 3.9.9 5.5-4.9-2.6L7.1 18l.9-5.5-4-3.9L9.5 8 12 3Z" fill="#22c55e"/></svg>
          <div><div class="t">Economic value (€)</div><div class="v" id="k_econ">—</div></div>
        </div>
      </div>
    </div>
  </aside>

  <div class="footer">© You • OpenStreetMap • MapLibre • PMTiles</div>

  <script src="./vendor/maplibre-gl.js"></script>
  <script src="./vendor/pmtiles.js"></script>
  <script>
    const PMTILES_URL = "https://pub-df9eaf452da44f0ea2cbbcb1a6cd55ac.r2.dev/trees.pmtiles";
    const SOURCE_LAYER = "trees";

    const protocol = new pmtiles.Protocol();
    maplibregl.addProtocol("pmtiles", protocol.tile);

    const map = new maplibregl.Map({
      container: "map",
      style: {
        version: 8,
        glyphs: "https://demotiles.maplibre.org/font/{fontstack}/{range}.pbf",
        sources: {
          osm: {
            type: "raster",
            tiles: ["https://tile.openstreetmap.org/{z}/{x}/{y}.png"],
            tileSize: 256,
            attribution: "© OpenStreetMap contributors"
          }
        },
        layers: [{ id: "osm", type: "raster", source: "osm" }]
      },
      center: [9.154940775917993, 45.46043264982563],
      zoom: 10.5
    });

    map.addControl(new maplibregl.NavigationControl(), "top-right");

    map.on("load", () => {
      const archive = new pmtiles.PMTiles(PMTILES_URL);
      protocol.add(archive);

      map.addSource("areas", { type: "vector", url: `pmtiles://${PMTILES_URL}` });

      map.addLayer({
        id: "areas-fill",
        type: "fill",
        source: "areas",
        "source-layer": SOURCE_LAYER,
        paint: { "fill-color": "#22c55e", "fill-opacity": 0.45 }
      });

      map.addLayer({
        id: "areas-outline",
        type: "line",
        source: "areas",
        "source-layer": SOURCE_LAYER,
        paint: { "line-color": "#0f291e", "line-width": 1.2 }
      });

      map.on("mouseenter", "areas-fill", () => map.getCanvas().style.cursor = "pointer");
      map.on("mouseleave", "areas-fill", () => map.getCanvas().style.cursor = "");

      map.on("click", "areas-fill", (e) => {
        const p = (e.features && e.features[0] && e.features[0].properties) || {};
        const site = p.site_name || p.name || "Green area";
        const co2 = coalesceNum(p.co2_sequestered_kg, p.co2_absorption_kg);
        const pm  = coalesceNum(p.pm10_capture_g, p.pm25_capture_g);
        const h2o = coalesceNum(p.h2o_retention_l, p.h2o_precipitation_l);
        const energy = coalesceNum(p.cooling_savings_kwh);
        const econ = coalesceNum(p.economic_value_eur, p.energy_value_eur, p.co2_absorption_value_eur);

        openSidebar({
          title: site,
          subtitle: "Lombardy • Urban Green",
          site,
          co2, pm, h2o, energy, econ
        });
      });
    });

    function coalesceNum(...vals){
      for (const v of vals){ if (v !== undefined && v !== null && v === v && v !== "") return Number(v); }
      return null;
    }
    function fmt(n, unit){
      if (n === null) return "—";
      const s = Number(n).toLocaleString(undefined, { maximumFractionDigits: 0 });
      return unit ? `${s} ${unit}` : s;
    }

    const sb = document.getElementById("sidebar");
    const sbClose = document.getElementById("sb-close");

    function openSidebar(d){
      document.getElementById("sb-title").textContent = d.title || "Green area";
      document.getElementById("sb-sub").textContent = d.subtitle || "";
      document.getElementById("sb-site").textContent = d.site || "—";
      document.getElementById("k_co2").textContent = fmt(d.co2, "kg");
      document.getElementById("k_pm").textContent = fmt(d.pm, "g");
      document.getElementById("k_h2o").textContent = fmt(d.h2o, "L");
      document.getElementById("k_energy").textContent = fmt(d.energy, "kWh");
      document.getElementById("k_econ").textContent = d.econ===null ? "—" : `€ ${fmt(d.econ)}`;
      sb.classList.add("open");
      sb.setAttribute("aria-hidden","false");
    }
    sbClose.addEventListener("click", () => {
      sb.classList.remove("open");
      sb.setAttribute("aria-hidden","true");
    });

    window.addEventListener("unload", ()=> protocol.removeAll());
  </script>
</body>
</html>

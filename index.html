<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Urban Green • Lombardy</title>
  <link href="./vendor/maplibre-gl.css" rel="stylesheet" />
  <style>
    :root{--bg:#0b1220;--panel:#0d1426;--muted:#8fa0bf;--text:#e6edf7;--green:#22c55e}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    #app{display:grid;grid-template-columns:1fr;grid-template-rows:100vh}
    #map{position:relative}
    #mapCanvas{position:absolute;inset:0}

    /* Sidebar hidden by default */
    #sidebar{
      position:absolute;left:0;top:0;width:min(380px,100%);height:100vh;
      background:var(--panel);border-right:1px solid #1f2937;padding:16px;overflow:auto;
      transform:translateX(-110%);transition:transform .25s ease;z-index:1000;
    }
    #sidebar.open{transform:none}

    h1{font-size:18px;margin:0 0 12px;display:flex;gap:10px;align-items:center}
    .muted{color:var(--muted)}
    .close{position:absolute;right:12px;top:10px;background:#0b1220;border:1px solid #1e2b4a;border-radius:8px;color:var(--text);padding:4px 8px;cursor:pointer}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .kpi{background:#091122;border:1px solid #203152;border-radius:12px;padding:12px}
    .kpi .t{color:var(--muted);font-size:12px}
    .kpi .v{font-size:16px;font-weight:600;margin-top:2px}
    .icons{display:flex;gap:8px;align-items:center}
    .footer{position:absolute;left:10px;bottom:8px;background:#0b1220cc;border:1px solid #1e2b4a;border-radius:8px;padding:6px 8px;font-size:12px;z-index:10}
    .maplibregl-ctrl-attrib{font-size:12px}
  </style>
</head>
<body>
  <div id="app">
    <aside id="sidebar">
      <button class="close" id="btnClose">Close</button>
      <h1>
        <svg width="28" height="28" viewBox="0 0 24 24" aria-hidden="true">
          <circle cx="12" cy="12" r="11" fill="#0ea5e9" stroke="#052e16"/>
          <path d="M7 16c0-3 2.1-5.5 5-5.5s5 2.5 5 5.5H7Z" fill="#22c55e"/>
          <path d="M12 6.2c1.8 0 3.3 1.5 3.3 3.3 0 .8-.3 1.5-.8 2.1l-1 .9-1.5-1.2c-.6-.6-1-1.3-1-2.1 0-1.8 1.5-3 3-3Z" fill="#14532d"/>
        </svg>
        Lombardy Green Area
      </h1>

      <div class="grid">
        <div class="kpi"><div class="icons">
          <svg width="20" height="20" viewBox="0 0 24 24" aria-hidden="true"><circle cx="12" cy="12" r="11" fill="#86efac"/><text x="8" y="14" font-size="9" font-family="monospace">O₂</text></svg>
          <div class="t">O₂ produced (yr)</div></div><div id="kpiO2" class="v">—</div></div>

        <div class="kpi"><div class="icons">
          <svg width="20" height="20" viewBox="0 0 24 24" aria-hidden="true"><circle cx="12" cy="12" r="11" fill="#67e8f9"/><text x="7" y="14" font-size="8" font-family="monospace">CO2</text></svg>
          <div class="t">CO₂ sequestered (yr)</div></div><div id="kpiCO2Seq" class="v">—</div></div>

        <div class="kpi"><div class="icons">
          <svg width="20" height="20" viewBox="0 0 24 24" aria-hidden="true"><circle cx="12" cy="12" r="11" fill="#fde68a"/><text x="9" y="15" font-size="10" font-family="monospace">€</text></svg>
          <div class="t">CO₂ absorption value (€)</div></div><div id="kpiCO2AbsVal" class="v">—</div></div>

        <div class="kpi"><div class="icons">
          <!-- Water drop icon -->
          <svg width="20" height="20" viewBox="0 0 24 24" aria-hidden="true">
            <path d="M12 3c3 4 5 6.5 5 9a5 5 0 0 1-10 0c0-2.5 2-5 5-9z" fill="#60a5fa"/>
            <path d="M6 18c1.2.8 2.4.8 3.6 0 1.2.8 2.4.8 3.6 0 1.2.8 2.4.8 3.6 0" stroke="#bcd7ff" stroke-width="1.6" fill="none" stroke-linecap="round"/>
          </svg>
          <div class="t">Water precipitation (L/yr)</div></div><div id="kpiH2OPrecip" class="v">—</div></div>

        <div class="kpi"><div class="icons">
          <svg width="20" height="20" viewBox="0 0 24 24" aria-hidden="true"><circle cx="12" cy="12" r="11" fill="#facc15"/><path d="M12 5l3 7h-3l2 7-6-9h3l-2-5z" fill="#0b1220"/></svg>
          <div class="t">Cooling savings (kWh/yr)</div></div><div id="kpiCooling" class="v">—</div></div>

        <div class="kpi"><div class="icons">
          <svg width="20" height="20" viewBox="0 0 24 24" aria-hidden="true"><circle cx="12" cy="12" r="11" fill="#d1d5db"/><text x="7" y="14" font-size="8" font-family="monospace">PM10</text></svg>
          <div class="t">PM10 captured (g/yr)</div></div><div id="kpiPM10" class="v">—</div></div>

        <div class="kpi"><div class="icons">
          <svg width="20" height="20" viewBox="0 0 24 24" aria-hidden="true"><circle cx="12" cy="12" r="11" fill="#67e8f9"/><text x="7" y="14" font-size="8" font-family="monospace">CO2</text></svg>
          <div class="t">CO₂ absorbed (kg/yr)</div></div><div id="kpiCO2AbsKg" class="v">—</div></div>

        <div class="kpi"><div class="icons">
          <svg width="20" height="20" viewBox="0 0 24 24" aria-hidden="true"><circle cx="12" cy="12" r="11" fill="#d1d5db"/><text x="6" y="14" font-size="8" font-family="monospace">PM2.5</text></svg>
          <div class="t">PM2.5 captured (g/yr)</div></div><div id="kpiPM25" class="v">—</div></div>

        <div class="kpi"><div class="icons">
          <svg width="20" height="20" viewBox="0 0 24 24" aria-hidden="true"><circle cx="12" cy="12" r="11" fill="#86efac"/><text x="7" y="15" font-size="8" font-family="monospace">CO₂</text></svg>
          <div class="t">CO₂ stock (kg)</div></div><div id="kpiCO2StockKg" class="v">—</div></div>

        <div class="kpi"><div class="icons">
          <svg width="20" height="20" viewBox="0 0 24 24" aria-hidden="true"><circle cx="12" cy="12" r="11" fill="#fde68a"/><text x="9" y="15" font-size="10" font-family="monospace">€</text></svg>
          <div class="t">CO₂ stock value (€)</div></div><div id="kpiCO2StockVal" class="v">—</div></div>

        <div class="kpi"><div class="icons">
          <svg width="20" height="20" viewBox="0 0 24 24" aria-hidden="true"><circle cx="12" cy="12" r="11" fill="#fde68a"/><text x="9" y="15" font-size="10" font-family="monospace">€</text></svg>
          <div class="t">Energy value (€)</div></div><div id="kpiEnergyVal" class="v">—</div></div>

        <div class="kpi"><div class="icons">
          <!-- Water drop icon -->
          <svg width="20" height="20" viewBox="0 0 24 24" aria-hidden="true">
            <path d="M12 3c3 4 5 6.5 5 9a5 5 0 0 1-10 0c0-2.5 2-5 5-9z" fill="#60a5fa"/>
            <path d="M6 18c1.2.8 2.4.8 3.6 0 1.2.8 2.4.8 3.6 0 1.2.8 2.4.8 3.6 0" stroke="#bcd7ff" stroke-width="1.6" fill="none" stroke-linecap="round"/>
          </svg>
          <div class="t">Water retained (L/yr)</div></div><div id="kpiH2ORet" class="v">—</div></div>
      </div>
    </aside>

    <main id="map">
      <div id="mapCanvas"></div>
      <div class="footer">© R3GIS</div>
    </main>
  </div>

  <script src="./vendor/maplibre-gl.js"></script>
  <script src="./vendor/pmtiles.js"></script>
  <script src="./vendor/basemaps.js"></script>
  <script>
    const PMTILES_URL = "https://pub-df9eaf452da44f0ea2cbbcb1a6cd55ac.r2.dev/trees.pmtiles";
    const SOURCE_LAYER = "trees";

    const protocol = new pmtiles.Protocol();
    maplibregl.addProtocol('pmtiles', protocol.tile);

    const style = {
      version: 8,
      glyphs: "https://demotiles.maplibre.org/font/{fontstack}/{range}.pbf",
      sources: {
        osm: { type:'raster', tiles:['https://tile.openstreetmap.org/{z}/{x}/{y}.png'], tileSize:256, attribution:'© OpenStreetMap contributors' }
      },
      layers: [{ id:'osm', type:'raster', source:'osm' }]
    };

    const map = new maplibregl.Map({
      container:'mapCanvas',
      style,
      center:[9.154940775917993,45.46043264982563],
      zoom:10.5
    });

    map.addControl(new maplibregl.NavigationControl(),'top-right');

    function addTreeIcon() {
      const svg = `
        <svg xmlns="http://www.w3.org/2000/svg" width="128" height="128" viewBox="0 0 64 64">
          <defs>
            <radialGradient id="g" cx="50%" cy="40%" r="60%">
              <stop offset="0%" stop-color="#34d399"/>
              <stop offset="100%" stop-color="#15803d"/>
            </radialGradient>
          </defs>
          <circle cx="32" cy="26" r="18" fill="url(#g)"/>
          <rect x="28" y="26" width="8" height="20" rx="2" fill="#4d342e"/>
          <path d="M16 30c6 3 10 3 16 0 6 3 10 3 16 0" fill="none" stroke="#86efac" stroke-width="3" stroke-linecap="round"/>
        </svg>`;
      const blob = new Blob([svg], {type: 'image/svg+xml'});
      const url = URL.createObjectURL(blob);
      return fetch(url)
        .then(r => r.blob())
        .then(b => createImageBitmap(b))
        .then(img => { map.addImage('tree-icon', img, { pixelRatio: 2 }); URL.revokeObjectURL(url); })
        .catch(() => { URL.revokeObjectURL(url); });
    }

    map.on('load', async () => {
      const archive = new pmtiles.PMTiles(PMTILES_URL);
      protocol.add(archive);

      await addTreeIcon(); // ensure the icon exists before adding symbol layer

      map.addSource('areas', { type:'vector', url:`pmtiles://${PMTILES_URL}` });

      // Polygon fill + outline
      map.addLayer({
        id:'areas-fill',
        type:'fill',
        source:'areas',
        'source-layer':SOURCE_LAYER,
        paint:{ 'fill-color':'#22c55e','fill-opacity':0.45 }
      });

      map.addLayer({
        id:'areas-outline',
        type:'line',
        source:'areas',
        'source-layer':SOURCE_LAYER,
        paint:{ 'line-color':'#052e16','line-width':1.2 }
      });

      // Tree icon symbol layer visible at ALL zooms, larger size at high zoom
      map.addLayer({
        id:'areas-icon',
        type:'symbol',
        source:'areas',
        'source-layer':SOURCE_LAYER,
        minzoom: 0,
        layout: {
          'symbol-placement': 'point',
          'icon-image': 'tree-icon',
          'icon-allow-overlap': true,
          'icon-ignore-placement': true,
          'icon-size': [
            'interpolate', ['linear'], ['zoom'],
            0, 1.4,   /* bigger at world view */
            6, 1.8,
            12, 2.4,
            16, 3.2
          ]
        }
      });

      map.on('mouseenter','areas-fill',()=>map.getCanvas().style.cursor='pointer');
      map.on('mouseleave','areas-fill',()=>map.getCanvas().style.cursor='');

      function handleClick(e){
        const features = e.features && e.features.length
          ? e.features
          : map.queryRenderedFeatures(e.point, { layers:['areas-icon','areas-fill','areas-outline'] });
        if (!features || !features.length) return;

        const p = features[0].properties || {};

        set('kpiO2',            p.o2_produced_kg,         'kg');
        set('kpiCO2Seq',        p.co2_sequestered_kg,     'kg');
        set('kpiCO2AbsVal',     p.co2_absorption_value_eur ?? p.co2_absorption_value, '€');
        set('kpiH2OPrecip',     p.h2o_precipitation_l,    'L');
        set('kpiCooling',       p.cooling_savings_kwh,    'kWh');
        set('kpiPM10',          p.pm10_capture_g,         'g');
        set('kpiCO2AbsKg',      p.co2_absorption_kg,      'kg');
        set('kpiPM25',          p.pm25_capture_g,         'g');
        set('kpiCO2StockKg',    p.co2_stock_kg,           'kg');
        set('kpiCO2StockVal',   p.co2_stock_value_eur,    '€');
        set('kpiEnergyVal',     p.energy_value_eur,       '€');
        set('kpiH2ORet',        p.h2o_retention_l,        'L');

        document.getElementById('sidebar').classList.add('open');
      }

      map.on('click','areas-icon', handleClick);
      map.on('click','areas-fill', handleClick);
      map.on('click','areas-outline', handleClick);
      map.on('click', handleClick);
    });

    function parseNum(v){
      if(v===undefined||v===null) return NaN;
      const s=(typeof v==='number')?String(v):String(v).replace(/\./g,'').replace(/,/g,'.');
      const m=s.match(/-?[0-9]*\.?[0-9]+/);
      return m?parseFloat(m[0]):NaN;
    }
    function set(id,v,unit){
      const el=document.getElementById(id);
      const n=parseNum(v);
      if(!isFinite(n)){el.textContent='—';return}
      el.textContent=n.toLocaleString(undefined,{maximumFractionDigits:0})+(unit?` ${unit}`:'');
    }

    document.getElementById('btnClose')
      .addEventListener('click', () => document.getElementById('sidebar').classList.remove('open'));

    window.addEventListener('unload',()=>protocol.removeAll());
  </script>
</body>
</html>
